---
description: push前のローカル変更をレビュー
allowed-tools: Bash(git diff:*), Bash(git status:*), Bash(git log:*), Bash(git rev-parse:*), Bash(git merge-base:*)
model: opus
---

**重要: すべてのレビュー結果は日本語で記述してください。**

push前のローカル変更に対してコードレビューを実行します。未プッシュの変更を対象とします。

**エージェントへの前提条件:**
- すべてのツールは正常に動作します。テスト呼び出しや探索的な呼び出しは不要です。
- タスク完了に必要な場合のみツールを呼び出してください。

## 実行手順

1. 未プッシュの変更を取得:
   ```bash
   # upstream が設定されているか確認
   if git rev-parse --abbrev-ref @{upstream} &>/dev/null; then
     # upstream との差分（未プッシュコミット + 未コミット変更）
     git diff @{upstream}
   else
     # 新規ブランチの場合は未コミット変更のみ
     git diff HEAD
   fi
   ```

   変更がない場合は「レビュー対象の変更がありません」と報告して終了。

2. Haiku エージェントを起動し、関連するCLAUDE.mdファイルのパス一覧を取得:
   - ルートのCLAUDE.md（存在する場合）
   - 変更されたファイルを含むディレクトリのCLAUDE.md

3. Sonnet エージェントを起動し、差分を確認して変更サマリーを作成

4. 4つのエージェントを並列起動して独立してレビュー。各エージェントは問題リストを返す（各問題には説明とフラグ理由を含む）:

   **エージェント 1 + 2: CLAUDE.md準拠チェック（Sonnet）**
   CLAUDE.mdへの準拠を並列で監査。ファイルの準拠評価時は、そのファイルまたは親ディレクトリと共通パスを持つCLAUDE.mdのみを考慮。

   **エージェント 3: バグスキャン（Opus）**
   明らかなバグをスキャン。差分のみに注目し、追加コンテキストは読まない。重大なバグのみフラグし、些細な指摘や誤検知の可能性が高いものは無視。

   **エージェント 4: セキュリティ・ロジックチェック（Opus）**
   導入されたコードの問題を探す。セキュリティ問題、不正なロジックなど。変更されたコード内の問題のみを対象。

   **重要: 高シグナルの問題のみをフラグすること:**
   - コンパイル/パースに失敗するコード（構文エラー、型エラー、import不足、未解決参照）
   - 入力に関係なく確実に誤った結果を生むコード（明確なロジックエラー）
   - 明確で曖昧さのないCLAUDE.md違反（違反しているルールを正確に引用できる）

   **フラグしないもの:**
   - コードスタイルや品質の懸念
   - 特定の入力や状態に依存する潜在的問題
   - 主観的な提案や改善

   問題が実際に存在するか確信がない場合はフラグしない。誤検知は信頼を損ない、レビュアーの時間を無駄にする。

5. ステップ4でエージェント3と4が検出した各問題について、並列サブエージェントを起動して検証。問題が高い確信度で実際の問題であることを検証。バグとロジック問題にはOpus、CLAUDE.md違反にはSonnetを使用。

6. ステップ5で検証されなかった問題を除外。これにより高シグナルの問題リストが得られる。

7. レビュー結果を以下の形式でターミナルに出力:

---

## ローカルコードレビュー結果

**対象:** 未プッシュの変更
**変更ファイル数:** X件

### 変更サマリー

[ステップ3で作成したサマリー]

### 検出された問題 (X件)

#### 1. [カテゴリ] ファイルパス:行番号

問題の説明

```言語
# 修正案（該当する場合）
コード例
```

---

問題が見つからなかった場合は以下を出力:

---

## ローカルコードレビュー結果

**対象:** 未プッシュの変更
**変更ファイル数:** X件

### 変更サマリー

[サマリー]

### 検出された問題

問題は見つかりませんでした。バグとCLAUDE.mdへの準拠をチェックしました。

✓ 構文エラー
✓ 型エラー
✓ ロジックエラー
✓ CLAUDE.md準拠

---

## 誤検知リスト

ステップ4と5で評価時に以下は誤検知としてフラグしないこと:

- 既存の問題（この変更で導入されたものではない）
- バグに見えるが実際には正しいコード
- シニアエンジニアがフラグしない些細な指摘
- リンターが検出する問題（リンター実行は不要）
- CLAUDE.mdで明示的に要求されていない一般的なコード品質の懸念
- コード内で明示的に無視されているCLAUDE.mdの問題（lint ignoreコメントなど）

## 注意事項

- 開始前にToDoリストを作成すること
- CLAUDE.md違反は違反しているルールを引用・リンクすること
- このコマンドはGitHubに何も投稿しない。出力はすべてローカルターミナルのみ

## 8. セルフレビューチェック

AIレビュー完了後、以下のgrepベースチェックを実行（ステップ1で取得した差分を使用）:

```bash
# デバッグコードの検出
git diff @{upstream} -U0 2>/dev/null || git diff HEAD -U0 | grep -E '^\+.*(console\.log|print\(|debugger|TODO|FIXME)' || true

# 認証情報らしき文字列の検出
git diff @{upstream} -U0 2>/dev/null || git diff HEAD -U0 | grep -iE '^\+.*(password|secret|api_key|token)\s*=' || true
```

検出された場合は警告として出力に追加:

```markdown
### ⚠️ セルフレビュー警告

以下の項目を手動で確認してください:

**デバッグコード検出:**
- `path/to/file.js:10` - console.log('debug')

**認証情報の可能性:**
- `path/to/config.py:5` - api_key = "..."
```

何も検出されなければこのセクションは省略。
